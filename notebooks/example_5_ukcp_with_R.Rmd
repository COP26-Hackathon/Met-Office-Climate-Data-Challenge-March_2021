---
title: "Met Office Climate Data Hackathon"
author: "R programming examples"
date: "2/3/2021"
output: 
  rmarkdown::github_document:
    toc: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Met Office Climate Data Hackathon

## Using R with UK Climate Projections data

This notebook shows you how to work with the UK Climate Projections available on the CEDA Archive using R. It demonstrates:
   
* how to read in a dataset,
* perform a few statistical tasks,
 + calculate decadal means,
 + calculate a simple spatial-average,
 + calculate monthly anomalies",
* how to create a simple and more advanced plots
     
This  code requires the following:

* UKCP data files
 + monthly mean monthly mean surface air temperature (available from CEDA Archive [here](http://dap.ceda.ac.uk/badc/ukcp18/data/land-rcm/uk/12km/rcp85/01/tas/mon/latest/tas_rcp85_land-rcm_uk_12km_01_mon_198012-208011.nc))
 + land mask (available from here)
 + daily maximum surface air temperatures (available from CEDA Archive [here](http://data.ceda.ac.uk/badc/ukcp18/data/land-rcm/uk/12km/rcp85/01/tasmax/day/latest))
 
Within R they are many ways of producing similar plots or analysis. The examples shown below illustrate one approach. I make no claim that this is the best or most efficient approach.  I'm always interested in learning new or different approaches to writing code in R. If you have some comments or code that you would like to share, I can be contacted at kate.brown@metoffice.gov.uk. I hope you enjoy the Hackathon.

Kate Brown 1/3/2021
 
## Preparatory actions

Load in relevant R libraries
```{r load libraries, echo=FALSE}
library(ncdf4)
library(ncdf4.helpers)
library(PCICt)
library(maps)
library(maptools)
library(proj4)
library(zoo)
library(raster)
library(viridis)
library(abind)
```

Specify directories and files

```{r}
ukcp_file <- '/project/ukcp/land-rcm/uk/12km/rcp85/01/tas/mon/v20190731/tas_rcp85_land-rcm_uk_12km_01_mon_198012-208011.nc'
ukcp_file_land_mask <- '/project/ukcp/extra/lsm_land-rcm_uk_12km.nc'
ukcp_file_directory_tasmax <- '/project/ukcp/land-rcm/uk/12km/rcp85/04/tasmax/day/v20190731'
ukcp_file_directory_tasmax_gcm = '/project/ukcp/land-gcm/uk/60km/rcp26/04/tasmax/day/v20200302'

```
Load a netCDF data files into R and print information about its contents.



```{r}

ncin <- nc_open(ukcp_file)

print(ncin)


```
print the objects in ncin (the netCDF file that has been read in).

```{r}

var_names <- unlist(attributes(ncin$var))

print(unname(var_names))  # uname removes the name attributes in R, so just the names of the objects are printed

```

Read temperature data in from the netCDF file

```{r}

temp_data <- ncvar_get(ncin, varid = "tas")

print("Dimension of the temperature array")
dim(temp_data)

cat("\n First 10 observations in temp_data \n")
head(temp_data)

```

Check what type of calendar the climate model is using
 
```{r}

cat("Number of days in model year is",ncin$dim$time$calendar)

```

As this is a non-standard calendar, our years only having 360 days, we need to use 
specialised functions to read in the calendar data. Such functions are available in the 
library ncdf4.helpers package, you will also need the PCICt library to use this package


```{r}

temp_time <- nc.get.time.series(ncin, v = "tas")

str(temp_time)


```

The mid-point of the month is printed out, and each month has 30 days. There are 1200
months in total.

Print out the first 6 and last 6 times

```{r}

head(temp_time)
tail(temp_time)
```
Climate years start in Dec, to coincide with the start of meteorological winter
(Dec, Jan , Feb) and end in Nov, the end of meteorological autumn (Sep, Oct,
Nov). The climate year 1981 consists of Dec 1980 and all the months in 1981
except Dec, which will start the next year. The data starts in Dec 1980 and ends 
in Nov 2080, so we have 1200 months in total

## Calculate decadal means

Split the temp data into decades - each decade will contain 10 x 12 months,
starting in Dec 2080 and ending Nov 2080. 



```{r Calculate decadal means}

# Calculate the month mean for the whole tegion
year_mean <- apply(temp_data, 3, mean)

# Define which month belongs to which decade
decade <- rep(1:10, each = 120)

#Calculate mean for each decade
decade_mean <- tapply(X = year_mean, INDEX = decade, FUN = mean)
cat("Mean for each decade \n", decade_mean)
mid_decade <- seq(from = 1985, to = 2075, by = 10)
plot(mid_decade, decade_mean, type = "l")


```

## Plot a smoothed time series of monthly means
Plot a smoothed time series using a 12-month running mean
over a plot of the monthly temperatures


```{r}

month_mean <- apply(temp_data, 3, mean)

roll_year_mean <- rollapply(month_mean, 12, mean)

plot(month_mean, col = "blue", type = "l")
lines(roll_year_mean, type = "l", col = "black", lwd = 2)

```

## Plotting maps of the data

Make a simple spatial plot of the first month in the data.
(There are probably many different ways in R that this can be done. The method 
shown below uses rasters, I expect these plots could also be produced using
ggplot or other graphical libraries in R)

Read netCDF file into R as a raster brick - a multi-layer raster object. Here
the layers are the months. plot the first month

```{r}

temp1 <- brick(ukcp_file, varname = "tas")

str(temp1)

plot(temp1,1)
```
Change the colour scheme I like viridis - meant to be good for most forms of
colour blindness and good for printing out in black and white.

```{r}
plot(temp1, 1, col = viridis(256))
```


Mask out the sea data

The land sea mask represents the sea as a missing value (NA)

```{r}

# Read in the land seas mask as a aster file
mask_lsm <- raster(ukcp_file_land_mask, varname = "lsm")


land <- mask(temp1, mask = is.na(mask_lsm), maskvalue = T)

plot(land, 1, col = viridis(256)) 
```
Add in a coastline for the UK. The added complication is that the temperature
data uses a transverse Mercator grid One approach is to project the UK
coastline on to the transverse Mercator grid.

```{r}

# Select out parts of the world map that we want

uk_coast <- map("world",
                c("UK", "Ireland", "Jersey", "Guernsey", "Isle of Man"),
                xlim = c(-11, 3),
                ylim = c(49, 60.9),
                fill = T,
                col = "transparent",
                plot = F)
  
ids <- sapply(strsplit(uk_coast$names, ":"), function(x) x[1])

# convert the coastlines a spatial polygon
  
uk_cst_sp <- map2SpatialPolygons(uk_coast, IDs = ids, proj4string =
                                     CRS("+proj=longlat +datum=WGS84"))

# Transform the spatial polygon from standard lat/lon projection to
# the projection used for the land sea mask.
uk_utm <- spTransform(uk_cst_sp, projection(land))

# plot the temperatures then add the coast outline

plot(land, 1, col = viridis(256))

plot(uk_utm, add = T)


```


Tidy up the appearance of the graph

```{r}

plot(land, 1, col = viridis(256), horizontal = T, main = "Plot title her deg C",
    legend.args = list(text = "Legend title"))

plot(uk_utm, add = T)

```

Working with daily files

1) load up new daily data

```{r}

dirname <- "/project/ukcp/land-gcm/uk/60km/rcp26/04/tasmax/day/v20200302"

temp_ds <- list.files(path = dirname, pattern =    '^tasmax_rcp26_land-gcm_uk_60km_04_day')

temp_ds <- temp_ds[9:15]

print(temp_ds)

temp_rcp26 <- NULL


for (itemp in paste(dirname, temp_ds, sep = "/")) {
  nc_rcp26 <- nc_open(itemp)
  
  var_data <- ncvar_get(nc_rcp26, varid = "tasmax")
  temp_rcp26 <- abind(temp_rcp26, var_data, along = 3)
}  

dim(temp_rcp26)

```

Subset the data to the first 70 years, 360 days in a year ,from 01 Dec 1979 to 30 Nov 2049
Also subset the data to the baseline period of Dec 1980 to Nov 2000
```{r}
temp_rcp26 <- temp_rcp26[, , 1:(70 * 360)]
baseline <- temp_rcp26[, , (720 + 1):(720 + 20 * 360)]
```

Calculate the spatial monthly mean monthly values for the baseline period

```{r}
spatial_daily_mean <- apply(baseline, 3, mean)

mon_ind_bsl <- rep(rep(1:12, each = 30), 20)

basemonth_mean <- tapply(X = spatial_daily_mean, INDEX = mon_ind_bsl, FUN = mean)
```

Calculate the spatial monthly means for the whole period of interest
```{r}

spatial_daily_mean_wp <- apply(temp_rcp26, 3, mean)

mon_ind_wp <- rep(rep(1:(12*70), each = 30))

wp_month_mean <- tapply(X = spatial_daily_mean_wp, INDEX = mon_ind_wp, FUN = mean)
```

Calculate the monthly anomalies and the annual anomalies derived from the monthly anomalies

```{r}

anom_mon <- wp_month_mean - rep(basemonth_mean, 70)

anom_year <- tapply(anom_mon, INDEX = rep(c(1:70),each = 12), FUN = mean)

```

Plot the result
```{r}

plot(wp_month_mean, type = "l", col = "#29AF7FFF",lwd = 1.5, ylim = c(-5,25))
lines(anom_mon, type = "l",col = "#95D840FF", lwd = 2)
lines(seq(from = 6, to = 840, by = 12), anom_year, type = "l", col = "#440154FF", lwd = 3)
```

